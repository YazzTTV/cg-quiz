// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum QuestionStatus {
  APPROVED
  PENDING
  REJECTED
}

enum DuoRoomStatus {
  waiting
  starting
  in_progress
  finished
}

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  passwordHash    String
  name            String?
  mascot          String?   // 'owl', 'lion', 'monkey', 'dolphin', 'bear'
  winStreak       Int       @default(0)
  lastActivityDate DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  createdQuestions     Question[]          @relation("QuestionCreator")
  userQuestionStates   UserQuestionState[]
  reportedQuestions    Report[]
  flashcards          Flashcard[]
  dailyChallengeAnswers UserDailyChallenge[]

  @@map("users")
}

model Question {
  id                String         @id @default(uuid())
  prompt            String
  explanation       String?
  comprehensionText String?
  difficulty        Int?
  source            String?
  status            QuestionStatus @default(PENDING)
  createdByUserId   String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relations
  createdBy         User?              @relation("QuestionCreator", fields: [createdByUserId], references: [id])
  choices           Choice[]
  userQuestionStates UserQuestionState[]
  tags              QuestionTag[]
  reports           Report[]
  flashcards        Flashcard[]

  @@index([status])
  @@map("questions")
}

model Choice {
  id         String   @id @default(uuid())
  questionId String
  text       String
  isCorrect  Boolean
  order      Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
  @@map("choices")
}

model UserQuestionState {
  id                  String    @id @default(uuid())
  userId              String
  questionId          String
  timesSeen           Int       @default(0)
  timesCorrect        Int       @default(0)
  lastAnsweredAt      DateTime?
  lastAnswerWasCorrect Boolean?
  nextReviewAt        DateTime?
  suspended           Boolean   @default(false)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([userId, questionId])
  @@index([userId, nextReviewAt])
  @@index([questionId])
  @@map("user_question_states")
}

model Tag {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  questions QuestionTag[]

  @@map("tags")
}

model QuestionTag {
  id         String   @id @default(uuid())
  questionId String
  tagId      String
  createdAt  DateTime @default(now())

  // Relations
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  tag      Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([questionId, tagId])
  @@index([questionId])
  @@index([tagId])
  @@map("question_tags")
}

model Report {
  id         String   @id @default(uuid())
  userId     String
  questionId String
  reason     String
  createdAt  DateTime @default(now())

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
  @@map("reports")
}

model Flashcard {
  id          String    @id @default(uuid())
  userId      String
  questionId  String
  aiContent   String?   // Contenu généré par IA pour la mémorisation
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([userId, questionId])
  @@index([userId])
  @@index([questionId])
  @@map("flashcards")
}

model DailyChallenge {
  id          String   @id @default(uuid())
  dayNumber   Int      @unique // Numéro du jour (1, 2, 3, ...)
  prompt      String   // Question de logique/math
  explanation String?  // Explication de la réponse
  publishedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  choices DailyChallengeChoice[]
  userAnswers UserDailyChallenge[]

  @@index([dayNumber])
  @@index([publishedAt])
  @@map("daily_challenges")
}

model DailyChallengeChoice {
  id              String         @id @default(uuid())
  dailyChallengeId String
  text            String
  isCorrect       Boolean
  order           Int
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  dailyChallenge DailyChallenge @relation(fields: [dailyChallengeId], references: [id], onDelete: Cascade)

  @@index([dailyChallengeId])
  @@map("daily_challenge_choices")
}

model UserDailyChallenge {
  id              String   @id @default(uuid())
  userId          String
  dailyChallengeId String
  selectedChoiceId String?
  isCorrect       Boolean?
  answeredAt      DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  dailyChallenge DailyChallenge @relation(fields: [dailyChallengeId], references: [id], onDelete: Cascade)

  @@unique([userId, dailyChallengeId])
  @@index([userId])
  @@index([dailyChallengeId])
  @@map("user_daily_challenges")
}

model DuoRoom {
  id                   String         @id @default(uuid())
  code                 String         @unique
  hostId               String
  hostName             String
  guestId              String?
  guestName            String?
  status               DuoRoomStatus  @default(waiting)
  currentQuestionIndex Int            @default(0)
  questions            Json?
  hostAnswers          Json?
  guestAnswers         Json?
  hostScore            Int            @default(0)
  guestScore           Int            @default(0)
  createdAt            DateTime       @default(now())
  startedAt            DateTime?
  updatedAt            DateTime       @updatedAt

  @@map("duo_rooms")
}
